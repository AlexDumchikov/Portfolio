<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    /* Define CSS variables for themes */
    :root {
      /* Dark theme (default) */
      --bg-body: #0f1a2b;
      --text-body: #e0e6f0;
      --text-source-label: #8b96a8;
      --text-h1: #ffffff;
      --bg-summary-card: #1c2d45;
      --border-summary-card: #2a3b55;
      --shadow-card: rgba(0,0,0,0.3);
      --bg-indicator-pos: rgba(0, 220, 130, 0.2);
      --color-indicator-pos: #00dc82;
      --bg-indicator-neg: rgba(255, 70, 70, 0.2);
      --color-indicator-neg: #ff4646;
      --bg-indicator-neu: rgba(150, 160, 180, 0.2);
      --color-indicator-neu: #96a0b4;
      --text-summary-title: #b8c6db;
      --text-summary-value: #ffffff;
      --color-diff-pos: #00dc82;
      --color-diff-neg: #ff4646;
      --bg-filter: #1c2d45;
      --border-filter-div: #375680;
      --text-filter-label: #b8c6db;
      --bg-input: #233751;
      --border-input: #375680;
      --text-input: #e0e6f0;
      --input-scheme: dark; /* For date picker styling */
      --bg-grouping-block: #234763;
      --bg-past-period-block: rgba(255,140,0,0.2);
      --bg-anomalies-block: rgba(255,70,70,0.2);
      --bg-average-block: rgba(147,112,219,0.2);
      --bg-chart-container: #1c2d45;
      /* Chart colors for dark theme */
      --chart-actual: #90FF0A;
      --chart-past: #E6542A;
      --chart-past-fill-start: rgba(230,84,42,0.8);
      --chart-past-fill-end: rgba(28, 45, 69, 0.1); /* Matches --bg-chart-container */
      --chart-average: white;
      --chart-anomalies: #AD0AFD;
      --chart-legend-text: #ffffff;
      /* Adjusted ticks/grid color for dark theme - less visible */
      --chart-ticks-text: rgba(255, 255, 255, 0.8); /* Semi-transparent white */
      --chart-title-text: #ffffff;
      --theme-toggle-bg: #2a3b55;
      --theme-toggle-text: #e0e6f0;
      --theme-toggle-hover-bg: #375680;
      /* New grid color variable */
      --chart-grid-color: rgba(255, 255, 255, 0.03); /* Lighter grid for dark theme */
    }

    body.light-theme {
      /* Light theme */
      --bg-body: #f9f9f9;
      --text-body: #333333;
      --text-source-label: gray;
      --text-h1: #333333;
      --bg-summary-card: #ffffff;
      --border-summary-card: #f0f0f0;
      --shadow-card: rgba(0,0,0,0.1);
      --bg-indicator-pos: rgba(0, 128, 0, 0.1);
      --color-indicator-pos: green;
      --bg-indicator-neg: rgba(255, 0, 0, 0.1);
      --color-indicator-neg: red;
      --bg-indicator-neu: rgba(128, 128, 128, 0.1);
      --color-indicator-neu: gray;
      --text-summary-title: #333333;
      --text-summary-value: #333333;
      --color-diff-pos: green;
      --color-diff-neg: red;
      --bg-filter: #ffffff;
      --border-filter-div: #cccccc;
      --text-filter-label: #333333;
      --bg-input: #ffffff;
      --border-input: #cccccc;
      --text-input: #333333;
      --input-scheme: light;
      --bg-grouping-block: #e0f7ff;
      --bg-past-period-block: rgba(255,165,0,0.2);
      --bg-anomalies-block: rgba(255,0,0,0.2);
      --bg-average-block: rgba(128,0,128,0.2);
      --bg-chart-container: #ffffff; /* Transparent container in light theme */
      /* Chart colors for light theme - These match the colors from light_.html */
      --chart-actual: blue;
      --chart-past: orange;
      --chart-past-fill-start: rgba(255,165,0,0.8);
      --chart-past-fill-end: rgba(255,255,255,0.1); /* Matches --bg-chart-container */
      --chart-average: purple;
      --chart-anomalies: red;
      --chart-legend-text: #333333;
      /* Adjusted ticks/grid color for light theme - less visible */
      --chart-ticks-text: rgba(0, 0, 0, 0.8); /* Semi-transparent black */
      --chart-title-text: #333333;
      --theme-toggle-bg: #e0e6f0;
      --theme-toggle-text: #0f1a2b;
      --theme-toggle-hover-bg: #cccccc;
      /* New grid color variable */
      --chart-grid-color: rgba(0, 0, 0, 0.03); /* Lighter grid for light theme */
    }

    /* Basic page styles */
    body {
      font-family: Arial, sans-serif;
      margin: 10px; /* Reduced margin */
      background: var(--bg-body);
      position: relative;
      color: var(--text-body);
      transition: background-color 0.0001s, color 0.0001s; /* Smooth transition */
      padding-top: 60px; /* Add padding to top to prevent content from being hidden by fixed header */
    }

    /* Positioning container for top-right elements */
    .top-right-controls {
        position: fixed; /* Use fixed positioning */
        top: 5px;
        right: 10px;
        display: flex;
        /* flex-direction: column;  Stack items vertically by default */
        align-items: center; /* Align items vertically in the center */
        gap: 5px; /* Space between items */
        z-index: 1000; /* Ensure it's above other content */
    }

    /* Theme toggle button */
    #theme-toggle {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background-color: var(--theme-toggle-bg);
        color: var(--theme-toggle-text);
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        box-shadow: var(--shadow-card);
        transition: background-color 0.0001s, color 0.0001s;
    }
    #theme-toggle:hover {
        background-color: var(--theme-toggle-hover-bg);
    }

    /* Source label */
    .source-label {
      position: absolute;
      top: 5px; /* Keep slightly above other elements */
      left: 5px;
      font-size: 11px;
      color: var(--text-source-label);
      font-style: italic;
    }

    /* MS Teams icon */
    .lkdn-icon {
      /* Reduced size by half */
      width: 22.5px;
      height: 22.5px;
      cursor: pointer;
      box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); /* Adjust shadow */
      border-radius: 3px; /* Adjust border-radius */
    }

    /* Page title */
    h1 {
      text-align: center;
      font-size: 20px;
      margin-top: 0; /* Removed top margin */
      margin-bottom: 5px; /* Reduced space below title */
      color: var(--text-h1);
    }

    /* Summary cards container */
    .summary-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px; /* Reduced gap */
      justify-content: center;
      margin-bottom: 10px; /* Reduced margin */
    }

    /* Individual summary card styles */
    .summary-card {
      position: relative;
      display: flex;
      flex-direction: column;
      min-width: 120px; /* Slightly reduced min-width */
      flex-grow: 1; /* Allow cards to grow */
      flex-basis: 120px; /* Suggest a base width */
      background: var(--bg-summary-card);
      border-radius: 8px; /* Slightly reduced border-radius */
      box-shadow: var(--shadow-card);
      padding: 10px; /* Reduced padding */
      text-align: left;
      border: 1px solid var(--border-summary-card);
      overflow: hidden;
      transition: background-color 0.0001s, border-color 0.0001s;
    }

    /* Indicator icon styles */
    .summary-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 10px; /* Adjusted position */
      left: 10px; /* Adjusted position */
      width: 20px; /* Slightly reduced size */
      height: 20px; /* Slightly reduced size */
      border-radius: 4px; /* Slightly reduced border-radius */
      transition: background-color 0.0001s, color 0.0001s;
    }

    /* Positive indicator (green) */
    .indicator-positive {
      background-color: var(--bg-indicator-pos);
      color: var(--color-indicator-pos);
    }

    /* Negative indicator (red) */
    .indicator-negative {
      background-color: var(--bg-indicator-neg);
      color: var(--color-indicator-neg);
    }

    /* Neutral indicator (gray) */
    .indicator-neutral {
      background-color: var(--bg-indicator-neu);
      color: var(--color-indicator-neu);
    }

    /* Summary title */
    .summary-title {
      font-weight: bold;
      margin-bottom: 5px; /* Reduced margin */
      padding-left: 28px; /* Adjusted space for the indicator icon */
      font-size: 0.9em; /* Slightly reduced font size */
      color: var(--text-summary-title);
      transition: color 0.0001s;
    }

    /* Summary value */
    .summary-value {
      font-size: 1.2em; /* Slightly reduced font size */
      font-weight: bold;
      margin-bottom: 2px; /* Reduced margin */
      color: var(--text-summary-value);
      transition: color 0.0001s;
    }

    /* Difference indicator */
    .summary-diff {
      font-size: 0.8em; /* Slightly reduced font size */
      display: flex;
      gap: 3px; /* Reduced gap */
      color: var(--text-body); /* Inherit default text color */
      transition: color 0.0001s;
    }

    /* Positive difference */
    .diff-positive {
      color: var(--color-diff-pos);
    }

    /* Negative difference */
    .diff-negative {
      color: var(--color-diff-neg);
    }

    /* Difference amount and percentage */
    .diff-amount, .diff-percentage {
      font-weight: 500;
    }

    /* Filter container */
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px; /* Reduced gap */
      margin-bottom: 10px; /* Reduced margin */
      padding: 8px; /* Reduced padding */
      background: var(--bg-filter);
      border-radius: 6px; /* Slightly reduced border-radius */
      box-shadow: var(--shadow-card);
      transition: background-color 0.0001s;
    }

    /* Individual filter element */
    .filter-container > div {
      border: 1px solid var(--border-filter-div);
      padding: 4px; /* Reduced padding */
      border-radius: 3px; /* Slightly reduced border-radius */
      transition: background-color 0.0001s, border-color 0.0001s;
    }

    /* Filter label */
    .filter-container label {
      font-weight: bold;
      margin-right: 4px; /* Reduced margin */
      font-size: 0.9em; /* Slightly reduced font size */
      color: var(--text-filter-label);
      transition: color 0.0001s;
    }

    /* Input and select field styles */
    .filter-container input, .filter-container select {
      padding: 4px 6px; /* Reduced padding */
      border: 1px solid var(--border-input);
      border-radius: 3px; /* Slightly reduced border-radius */
      background-color: var(--bg-input);
      color: var(--text-input);
      font-size: 0.9em; /* Slightly reduced font size */
      transition: background-color 0.0001s, color 0.0001s, border-color 0.0001s;
    }

    /* Date input calendar styling */
    .filter-container input[type="date"] {
       color-scheme: var(--input-scheme);
    }
    .filter-container input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(var(--input-scheme, 0)); /* Invert calendar icon in dark theme */
    }


    /* Grouping block highlight */
    .grouping-block {
      background-color: var(--bg-grouping-block);
    }

    /* Past period block highlight */
    .past-period-block {
      background-color: var(--bg-past-period-block);
    }

    /* Anomalies block highlight */
    .anomalies-block {
      background-color: var(--bg-anomalies-block);
    }

    /* Average block highlight */
    .average-block {
      background-color: var(--bg-average-block);
    }

    /* Chart container */
    .chart-container {
      border-radius: 8px;
      box-shadow: var(--shadow-card);
      background-color: var(--bg-chart-container);
      padding: 10px;
      transition: background-color 0.0001s;
      /* Modified width and margin */
      width: 95%; /* Decreased width */
      margin: 10px auto; /* Center the block and add vertical margin */
      height: 400px; /* Keep original height or adjust as needed */
    }

    /* Make canvas responsive within its container */
    #salesChart {
        width: 100% !important;
        height: 100% !important;
    }

    /* --- Responsive Adjustments --- */

    /* For screens smaller than 600px */
    @media (max-width: 600px) {
        body {
            margin: 5px; /* Even less margin on smaller screens */
            padding-top: 100px; /* More padding for fixed header */
        }

        .top-right-controls {
            flex-direction: column; /* Stack vertically */
            align-items: flex-end; /* Align to the right */
            gap: 3px; /* Smaller gap */
            top: 5px; /* Adjust top position */
            right: 5px; /* Adjust right position */
        }

        .lkdn-icon {
            width: 20px; /* Slightly smaller icon */
            height: 20px;
        }

        #theme-toggle {
            padding: 6px 10px; /* Smaller padding */
            font-size: 11px; /* Smaller font size */
        }

        h1 {
            font-size: 18px; /* Smaller title font size */
            margin-bottom: 5px; /* Reduced margin */
        }

        .summary-container {
            gap: 5px; /* Even less gap between summary cards */
            margin-bottom: 5px; /* Reduced margin */
        }

        .summary-card {
            min-width: 100px; /* Allow cards to shrink more */
            flex-basis: 100px; /* Suggest a smaller base width */
            padding: 8px; /* Reduced padding */
        }

        .summary-indicator {
            top: 8px; /* Adjusted position */
            left: 8px; /* Adjusted position */
            width: 18px; /* Smaller size */
            height: 18px; /* Smaller size */
        }

         .summary-title {
            padding-left: 24px; /* Adjusted space */
            font-size: 0.8em; /* Smaller font size */
        }

        .summary-value {
            font-size: 1em; /* Smaller font size */
        }

        .summary-diff {
            font-size: 0.7em; /* Smaller font size */
            gap: 2px; /* Smaller gap */
        }

        .filter-container {
            gap: 8px; /* Reduced gap */
            margin-bottom: 8px; /* Reduced margin */
            padding: 6px; /* Reduced padding */
            flex-direction: column; /* Stack filters vertically on small screens */
            align-items: stretch; /* Stretch filters to fill width */
        }

        .filter-container > div {
            padding: 3px; /* Reduced padding */
        }

        .filter-container label,
        .filter-container input,
        .filter-container select {
             font-size: 0.8em; /* Smaller font size for filter elements */
        }

        .chart-container {
            padding: 5px; /* Reduced padding */
            height: 300px; /* Potentially reduce chart height on very small screens */
            width: 100%; /* Full width on small screens */
            margin: 8px auto; /* Reduced vertical margin */
        }
    }

    /* For screens between 601px and 900px */
    @media (min-width: 601px) and (max-width: 900px) {
        body {
            padding-top: 70px; /* Adjust padding for fixed header */
        }
        .top-right-controls {
             top: 5px;
             right: 8px;
             gap: 4px;
             flex-direction: row; /* Arrange horizontally */
        }
        .lkdn-icon {
            width: 21px; /* Slightly smaller icon */
            height: 21px;
        }
        #theme-toggle {
            padding: 7px 11px;
            font-size: 12px;
        }
        h1 {
            font-size: 19px;
        }
        .summary-container {
            gap: 8px;
            margin-bottom: 10px; /* Reduced margin */
        }
        .summary-card {
             min-width: 130px;
             flex-basis: 130px;
             padding: 12px;
        }
         .summary-indicator {
            top: 12px;
            left: 12px;
            width: 22px;
            height: 22px;
        }
         .summary-title {
            padding-left: 30px;
            font-size: 0.85em;
        }
         .summary-value {
            font-size: 1.1em;
        }
         .summary-diff {
            font-size: 0.75em;
            gap: 3px;
        }
        .filter-container {
            gap: 12px;
            margin-bottom: 10px; /* Reduced margin */
            padding: 9px;
            flex-direction: column; /* Stack filters vertically */
            align-items: stretch;
        }
        .filter-container > div {
            padding: 3px;
        }
         .filter-container label,
        .filter-container input,
        .filter-container select {
             font-size: 0.9em;
        }
        .chart-container {
            height: 350px; /* Adjust chart height */
            width: 95%; /* Decreased width */
            margin: 10px auto; /* Center and add vertical margin */
        }
    }

    /* Default styles for larger screens (>= 901px) */
    @media (min-width: 901px) {
         body {
            padding-top: 0; /* No padding needed for larger screens */
        }
        .top-right-controls {
            position: absolute; /* Use absolute positioning */
            flex-direction: row; /* Arrange horizontally */
            align-items: center;
            gap: 5px;
            top: -3px; /* Adjust position */
            right: 5px; /* Adjust position */
        }
         .lkdn-icon {
            /* Reduced size by half */
            width: 22.5px;
            height: 22.5px;
        }
        #theme-toggle {
            padding: 5px 12px;
            font-size: 12px;
        }
         h1 {
            font-size: 20px;
            margin-top: 10px;
            margin-bottom: 5px; /* Reduced margin */
        }
         .summary-container {
            gap: 15px;
            margin-bottom: 10px; /* Reduced margin */
        }
         .summary-card {
             min-width: 140px;
             flex-basis: 140px;
             padding: 15px;
        }
         .summary-indicator {
            top: 15px;
            left: 15px;
            width: 24px;
            height: 24px;
        }
         .summary-title {
            padding-left: 32px;
            font-size: 0.9em;
        }
         .summary-value {
            font-size: 1.3em;
        }
         .summary-diff {
            font-size: 0.9em;
            gap: 5px;
        }
        .filter-container {
            gap: 15px;
            margin-bottom: 10px; /* Reduced margin */
            padding: 10px;
             flex-direction: row; /* Arrange filters horizontally */
             align-items: center;
             justify-content: center;
        }
         .filter-container > div {
            padding: 5px;
        }
         .filter-container label,
        .filter-container input,
        .filter-container select {
             font-size: 1em;
        }
        .chart-container {
            height: 400px; /* Default chart height */
            width: 98%; /* Decreased width */
            margin: 10px auto; /* Center and add vertical margin */
        }
    }


  </style>
</head>
<body>
  <div class="source-label">Source: Random Data</div>

  <div class="top-right-controls">
    <button id="theme-toggle">Light Mode</button>
    <a href="https://www.linkedin.com/in/aleksandr-dumchykov-a1894188/" target="_blank">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/LinkedIn_icon.svg/1024px-LinkedIn_icon.svg.png" alt="Linkedin" class="lkdn-icon">
    </a>
  </div>


  <h1>SALES DYNAMICS (DEMO)</h1>

  <div class="summary-container">
    <div class="summary-card" id="summary-ytd">
      <div class="summary-indicator indicator-neutral">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M3 8H13" fill="currentColor" />
        </svg>
      </div>
      <div class="summary-title">YTD</div>
      <div class="summary-value">0</div>
      <div class="summary-diff">
        <span class="diff-amount">0</span>
        <span class="diff-percentage">(0%)</span>
      </div>
    </div>

    <div class="summary-card" id="summary-lastweek">
       <div class="summary-indicator indicator-neutral">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
           <path d="M3 8H13" fill="currentColor" />
        </svg>
      </div>
      <div class="summary-title">Week to Date</div>
      <div class="summary-value">0</div>
      <div class="summary-diff">
        <span class="diff-amount">0</span>
        <span class="diff-percentage">(0%)</span>
      </div>
    </div>

    <div class="summary-card" id="summary-lastmonth">
       <div class="summary-indicator indicator-neutral">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
           <path d="M3 8H13" fill="currentColor" />
        </svg>
      </div>
      <div class="summary-title">Month to Date</div>
      <div class="summary-value">0</div>
      <div class="summary-diff">
        <span class="diff-amount">0</span>
        <span class="diff-percentage">(0%)</span>
      </div>
    </div>

    <div class="summary-card" id="summary-last3m">
       <div class="summary-indicator indicator-neutral">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
           <path d="M3 8H13" fill="currentColor" />
        </svg>
      </div>
      <div class="summary-title">Last 3M</div>
      <div class="summary-value">0</div>
      <div class="summary-diff">
        <span class="diff-amount">0</span>
        <span class="diff-percentage">(0%)</span>
      </div>
    </div>

    <div class="summary-card" id="summary-last6m">
       <div class="summary-indicator indicator-neutral">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
           <path d="M3 8H13" fill="currentColor" />
        </svg>
      </div>
      <div class="summary-title">Last 6M</div>
      <div class="summary-value">0</div>
      <div class="summary-diff">
        <span class="diff-amount">0</span>
        <span class="diff-percentage">(0%)</span>
      </div>
    </div>

    <div class="summary-card" id="summary-last12m">
       <div class="summary-indicator indicator-neutral">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
           <path d="M3 8H13" fill="currentColor" />
        </svg>
      </div>
      <div class="summary-title">Last 12M</div>
      <div class="summary-value">0</div>
      <div class="summary-diff">
        <span class="diff-amount">0</span>
        <span class="diff-percentage">(0%)</span>
      </div>
    </div>
  </div>

  <div class="filter-container">
    <div>
      <label for="startDate">Start:</label>
      <input type="date" id="startDate">
    </div>

    <div>
      <label for="endDate">End:</label>
      <input type="date" id="endDate">
    </div>

    <div class="grouping-block">
      <label for="grouping">Grouping:</label>
      <select id="grouping">
        <option value="daily">Daily</option>
        <option value="weekly" selected>Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>

    <div class="extra-checkbox past-period-block">
      <label for="togglePastPeriod">Past Period:</label>
      <input type="checkbox" id="togglePastPeriod"> </div>

    <div class="extra-checkbox">
      <label for="toggleGrid">Grid:</label>
      <input type="checkbox" id="toggleGrid" checked>
    </div>

    <div class="extra-checkbox">
      <label for="toggleDataValues">Data:</label>
      <input type="checkbox" id="toggleDataValues">
    </div>

    <div class="extra-checkbox anomalies-block">
      <label for="toggleAnomalies">Anomalies:</label>
      <input type="checkbox" id="toggleAnomalies">
    </div>

    <div class="extra-checkbox average-block">
      <label for="toggleAverage">Average:</label>
      <input type="checkbox" id="toggleAverage">
    </div>
  </div>

  <div class="chart-container">
    <canvas id="salesChart"></canvas>
  </div>

  <script>
    // Register Chart.js plugins
    Chart.register(ChartDataLabels);

    /**
     * Formats a date as YYYY-MM-DD
     * @param {Date|string} date - The date to format
     * @return {string} The formatted date string
     */
    function formatDate(date) {
      const d = new Date(date);
      let month = '' + (d.getMonth() + 1);
      let day = '' + d.getDate();
      const year = d.getFullYear();
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;
      return [year, month, day].join('-');
    }

    /**
     * Subtracts one year from a date string
     * @param {string} dateStr - Date string in YYYY-MM-DD format
     * @return {string} Date string one year earlier
     */
    function subtractOneYear(dateStr) {
      const date = new Date(dateStr);
      date.setFullYear(date.getFullYear() - 1);
      return formatDate(date);
    }

    /**
     * Gets the ISO week-numbering year for a date
     * @param {Date} date - The date to check
     * @return {number} The ISO week year
     */
    function getISOWeekYear(date) {
      const target = new Date(date.valueOf());
      const dayNr = (date.getDay() + 6) % 7;
      target.setDate(target.getDate() - dayNr + 3);
      return target.getFullYear();
    }

    /**
     * Groups sales data by the specified time period
     * @param {Array} data - Array of sales data objects
     * @param {string} grouping - Grouping type ('daily', 'weekly', 'monthly', 'quarterly', 'yearly')
     * @return {Array} Array of grouped data objects
     */
    function groupData(data, grouping) {
      const groups = {};
      data.forEach(item => {
        const date = new Date(item.date);
        let key = '';
        let sortDate = date;

        switch (grouping) {
          case 'daily':
            key = item.date;
            sortDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            break;

          case 'weekly': {
            const dateStr = formatDate(date);
            // Special handling for week spanning year change (e.g., 2024-12-30 to 2025-01-05)
            if (dateStr >= "2024-12-30" && dateStr <= "2025-01-05") {
              key = "2025-01"; // Use year and week number
              sortDate = new Date("2024-12-30"); // Start of the week for sorting
            } else {
              const weekNumber = getWeekNumber(date);
              const weekStr = ("0" + weekNumber).slice(-2);
              const isoYear = getISOWeekYear(date);
              key = isoYear + '-' + weekStr;
              const dayNr = (date.getDay() + 6) % 7; // 0 = Monday, 6 = Sunday
              const monday = new Date(date);
              monday.setDate(date.getDate() - dayNr); // Monday's date
              sortDate = monday;
            }
            break;
          }

          case 'monthly':
            key = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2);
            sortDate = new Date(date.getFullYear(), date.getMonth(), 1);
            break;

          case 'quarterly': {
            const quarter = Math.floor(date.getMonth() / 3) + 1;
            key = date.getFullYear() + '-Q' + quarter;
            sortDate = new Date(date.getFullYear(), (quarter - 1) * 3, 1);
            break;
          }

          case 'yearly':
            key = date.getFullYear().toString();
            sortDate = new Date(date.getFullYear(), 0, 1);
            break;

          default: // Default to daily
            key = item.date;
            sortDate = date;
        }

        if (!groups[key]) {
          groups[key] = { total: 0, sortDate: sortDate, label: key };
        }
        groups[key].total += item.sales;
      });

      // Convert groups object to array and sort by date
      const result = [];
      for (let k in groups) {
        result.push({ label: groups[k].label, value: groups[k].total, sortDate: groups[k].sortDate });
      }
      result.sort((a, b) => a.sortDate - b.sortDate);
      return result;
    }

    /**
     * Gets the week number for a date
     * @param {Date} date - The date to check
     * @return {number} The week number
     */
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }


    /**
     * Gets the label for the past period (1 year ago)
     * @param {string} label - Current period label
     * @param {string} grouping - Grouping type
     * @return {string} Past period label
     */
    function getPastLabel(label, grouping) {
      if (grouping === 'daily') {
        const parts = label.split('-');
        const year = parseInt(parts[0]) - 1;
        return year + '-' + parts[1] + '-' + parts[2];
      } else if (grouping === 'weekly') {
        const parts = label.split('-');
        const year = parseInt(parts[0]) - 1;
        return year + '-' + parts[1];
      } else if (grouping === 'monthly') {
        const parts = label.split('-');
        const year = parseInt(parts[0]) - 1;
        return year + '-' + parts[1];
      } else if (grouping === 'quarterly') {
        const parts = label.split('-Q');
        const year = parseInt(parts[0]) - 1;
        return year + '-Q' + parts[1];
      } else if (grouping === 'yearly') {
        const year = parseInt(label) - 1;
        return year.toString();
      }
      return label; // Return original label if type not recognized
    }

    /**
     * Formats the X-axis label depending on the grouping type
     * @param {Date} date - The date to format
     * @param {string} grouping - Grouping type
     * @return {string} Formatted label
     */
    function formatXAxisLabel(date, grouping) {
      if (grouping === 'weekly') {
        const dateStr = formatDate(date);
        // Special handling for week spanning year change
        if (dateStr >= "2024-12-30" && dateStr <= "2025-01-05") {
          return "2025-01"; // Label for the first week of 2025
        }
        const weekNumber = getWeekNumber(date);
        const weekStr = ("0" + weekNumber).slice(-2);
        const isoYear = getISOWeekYear(date); // Use ISO year
        return isoYear + '-' + weekStr;
      } else if (grouping === 'monthly') {
        // Format 'Jan-24'
        return date.toLocaleString('en-US', { month: 'short', year: '2-digit' }).replace(' ', '-');
      } else if (grouping === 'quarterly') {
        const quarter = Math.floor(date.getMonth() / 3) + 1;
        return date.getFullYear() + '-Q' + quarter;
      } else if (grouping === 'yearly') {
        return date.getFullYear().toString();
      }
      // Default to daily date
      return date.toLocaleDateString('en-US');
    }

    /**
     * Sums sales within a given date range
     * @param {Array} data - Array of sales data
     * @param {string} start - Start date string
     * @param {string} end - End date string
     * @return {number} Total sales in the range
     */
    function sumSalesInRange(data, start, end) {
      const startTime = new Date(start).getTime();
      const endTime = new Date(end).getTime();
      let sum = 0;
      data.forEach(item => {
        // Ensure we compare dates only, ignoring time
        const itemDateOnly = new Date(item.date);
        itemDateOnly.setHours(0, 0, 0, 0);
        const t = itemDateOnly.getTime();

        if (t >= startTime && t <= endTime) {
          sum += item.sales;
        }
      });
      return sum;
    }


    /**
     * Gets the date N days before a given date
     * @param {string} dateStr - Start date string
     * @param {number} n - Number of days to go back
     * @return {string} Date string N days prior
     */
    function dateNDaysBefore(dateStr, n) {
      const d = new Date(dateStr);
      d.setDate(d.getDate() - n);
      return formatDate(d);
    }

    /**
     * Formats a number with 1 decimal place using English locale
     * @param {number} num - The number to format
     * @return {string} Formatted number string
     */
    function formatNumber(num) {
        if (typeof num !== 'number') {
            console.warn("formatNumber received non-numeric value:", num);
            num = 0; // Default value or error handling
        }
      // Use 'en-US' for US English number formatting (period as decimal separator)
      return num.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    }

    /**
     * Updates a summary card with current and previous values
     * @param {string} cardId - ID of the card element
     * @param {number} currentSum - Current period sum
     * @param {number} previousSum - Previous period sum
     */
    function updateSummaryCard(cardId, currentSum, previousSum) {
      const card = document.getElementById(cardId);
      if (!card) return; // Exit if card not found

      const valueEl = card.querySelector(".summary-value");
      const diffAmountEl = card.querySelector(".diff-amount");
      const diffPercentEl = card.querySelector(".diff-percentage");
      const indicator = card.querySelector(".summary-indicator");
      const summaryDiff = card.querySelector(".summary-diff");

      // Update main value
      valueEl.textContent = formatNumber(currentSum);

      // Calculate difference and percentage
      const diff = currentSum - previousSum;
      // Check for division by zero
      const diffPercent = previousSum !== 0 ? (diff / previousSum) * 100 : (currentSum > 0 ? Infinity : 0);

      const diffStr = formatNumber(diff);
      let pctStr = "(0.0%)"; // Default
      if (diffPercent === Infinity) {
          pctStr = "(∞%)"; // Handle infinity
      } else if (!isNaN(diffPercent)) {
          pctStr = "(" + (diff >= 0 ? "+" : "") + formatNumber(diffPercent) + "%)";
      }


      // If it's the YTD card, update the page title
      if(cardId === "summary-ytd"){
        document.title = "Sales YTD: " + formatNumber(currentSum) + " " + pctStr;
      }

      // Update indicator icon and colors based on difference
      const svgPath = indicator.querySelector("path");
      indicator.classList.remove("indicator-positive", "indicator-negative", "indicator-neutral");
      summaryDiff.classList.remove("diff-positive", "diff-negative");

      if (diff > 0) {
        // Positive change - green up arrow
        indicator.classList.add("indicator-positive");
        summaryDiff.classList.add("diff-positive");
        svgPath.setAttribute("d", "M8 3L14 9H10V13H6V9H2L8 3Z"); // Up arrow
      } else if (diff < 0) {
        // Negative change - red down arrow
        indicator.classList.add("indicator-negative");
        summaryDiff.classList.add("diff-negative");
        svgPath.setAttribute("d", "M8 13L2 7H6V3H10V7H14L8 13Z"); // Down arrow
      } else {
        // No change - gray horizontal line
        indicator.classList.add("indicator-neutral");
        svgPath.setAttribute("d", "M3 8H13"); // Horizontal line
      }

      // Update difference values
      diffAmountEl.textContent = diffStr;
      diffPercentEl.textContent = pctStr;
    }

    /**
     * Updates a period summary card (e.g., Last 3M, 6M, 12M)
     * @param {string} cardId - ID of the card element
     * @param {number} days - Number of days in the period
     * @param {Array} data - Array of sales data
     * @param {string} endStr - End date string
     */
    function updateSummaryPeriod(cardId, days, data, endStr) {
      const startStr = dateNDaysBefore(endStr, days - 1);
      const sumCurrent = sumSalesInRange(data, startStr, endStr);

      const prevEndStr = dateNDaysBefore(startStr, 1); // End of previous period
      const prevStartStr = dateNDaysBefore(prevEndStr, days - 1); // Start of previous period
      const sumPrev = sumSalesInRange(data, prevStartStr, prevEndStr);

      updateSummaryCard(cardId, sumCurrent, sumPrev);
    }

    /**
     * Renders all summary cards
     * @param {Array} allData - Full array of sales data
     */
    function renderSummaries(allData) {
      if (!allData || allData.length === 0) {
        resetAllSummaries(); // Reset if no data
        return;
      }

      // Find the latest date in the data
      const maxDate = new Date(Math.max(...allData.map(item => new Date(item.date).getTime())));
      const endStr = formatDate(maxDate); // End of the current period

      // Calculate YTD (Year-To-Date)
      const currentYear = maxDate.getFullYear();
      const ytdStartStr = formatDate(new Date(currentYear, 0, 1)); // Start of current year
      const ytdPrevStart = formatDate(new Date(currentYear - 1, 0, 1)); // Start of previous year
      // End of previous year corresponding to the current date
      const ytdPrevEnd = formatDate(new Date(currentYear - 1, maxDate.getMonth(), maxDate.getDate()));
      const ytdSum = sumSalesInRange(allData, ytdStartStr, endStr);
      const ytdPrevSum = sumSalesInRange(allData, ytdPrevStart, ytdPrevEnd);
      updateSummaryCard("summary-ytd", ytdSum, ytdPrevSum);

      // Calculate Week-To-Date
      const monday = getMonday(maxDate); // Monday of the current week
      const weekToDateSum = sumSalesInRange(allData, formatDate(monday), endStr);
      // Number of days from the start of the week to the current date
      const weekDaysCount = Math.floor((maxDate.getTime() - monday.getTime()) / (1000 * 60 * 60 * 24)) + 1;
      const previousMonday = new Date(monday);
      previousMonday.setDate(previousMonday.getDate() - 7); // Monday of the previous week
      const previousWeekEnd = new Date(previousMonday);
      previousWeekEnd.setDate(previousWeekEnd.getDate() + weekDaysCount - 1); // End of the previous week (up to the same day)
      const weekToDatePrevSum = sumSalesInRange(allData, formatDate(previousMonday), formatDate(previousWeekEnd));
      updateSummaryCard("summary-lastweek", weekToDateSum, weekToDatePrevSum);

      // Calculate Month-To-Date
      const currentMonthStart = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1); // Start of current month
      const monthToDateSum = sumSalesInRange(allData, formatDate(currentMonthStart), endStr);
      const previousMonthStart = new Date(maxDate.getFullYear(), maxDate.getMonth() - 1, 1); // Start of previous month
      const previousMonthEnd = new Date(previousMonthStart);
      previousMonthEnd.setDate(previousMonthEnd.getDate() + maxDate.getDate() - 1); // End of previous month (up to the same day number)
      const monthToDatePrevSum = sumSalesInRange(allData, formatDate(previousMonthStart), formatDate(previousMonthEnd));
      updateSummaryCard("summary-lastmonth", monthToDateSum, monthToDatePrevSum);

      // Calculate for Last 3M, 6M, 12M
      updateSummaryPeriod("summary-last3m", 90, allData, endStr);
      updateSummaryPeriod("summary-last6m", 180, allData, endStr);
      updateSummaryPeriod("summary-last12m", 365, allData, endStr);
    }

    /**
     * Resets all summary cards to zero values
     */
    function resetAllSummaries() {
      const ids = ["summary-ytd", "summary-lastweek", "summary-lastmonth", "summary-last3m", "summary-last6m", "summary-last12m"];
      ids.forEach(id => {
        const card = document.getElementById(id);
        if (!card) return;
        card.querySelector(".summary-value").textContent = "0.0";
        card.querySelector(".diff-amount").textContent = "0.0";
        card.querySelector(".diff-percentage").textContent = "(0.0%)";
        const indicator = card.querySelector(".summary-indicator");
        const summaryDiff = card.querySelector(".summary-diff");
        indicator.classList.remove("indicator-positive", "indicator-negative");
        indicator.classList.add("indicator-neutral");
        const svgPath = indicator.querySelector("path");
        svgPath.setAttribute("d", "M3 8H13"); // Horizontal line
        summaryDiff.classList.remove("diff-positive", "diff-negative");
      });
       document.title = "Sales Report"; // Reset title
    }

    /**
     * Gets the Monday of the week for a given date
     * @param {Date} date - The date to check
     * @return {Date} Monday of that week
     */
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
      // Calculate the difference in days to Monday
      // If the day is Sunday (0), subtract 6 days. Otherwise, subtract (day - 1).
      const diff = d.getDate() - (day === 0 ? 6 : day - 1);
      return new Date(d.getFullYear(), d.getMonth(), diff);
    }

    /**
     * Initializes date filters with min/max dates from the data
     */
    function initializeDateFilters() {
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');

      if (!salesData || salesData.length === 0) {
         // Set default dates if no data exists
         const today = new Date();
         const oneYearAgo = new Date();
         oneYearAgo.setFullYear(today.getFullYear() - 1);
         startDateInput.value = formatDate(oneYearAgo);
         endDateInput.value = formatDate(today);
         return;
      }

      const dates = salesData.map(item => new Date(item.date));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      // Set min/max ranges and default values for filters
      startDateInput.min = formatDate(minDate);
      startDateInput.max = formatDate(maxDate);
      endDateInput.min = formatDate(minDate);
      endDateInput.max = formatDate(maxDate);
      startDateInput.value = formatDate(minDate); // Default to earliest date
      endDateInput.value = formatDate(maxDate);   // Default to latest date
    }

    // Example sales data (usually loaded from an API)
    const salesData = [
{ date: '2023-01-02', sales: 188},
{ date: '2023-01-03', sales: 109},
{ date: '2023-01-04', sales: 197},
{ date: '2023-01-05', sales: 176},
{ date: '2023-01-06', sales: 134},
{ date: '2023-01-07', sales: 158},
{ date: '2023-01-08', sales: 171},
{ date: '2023-01-09', sales: 183},
{ date: '2023-01-10', sales: 155},
{ date: '2023-01-11', sales: 109},
{ date: '2023-01-12', sales: 186},
{ date: '2023-01-13', sales: 164},
{ date: '2023-01-14', sales: 143},
{ date: '2023-01-15', sales: 155},
{ date: '2023-01-16', sales: 191},
{ date: '2023-01-17', sales: 191},
{ date: '2023-01-18', sales: 109},
{ date: '2023-01-19', sales: 153},
{ date: '2023-01-20', sales: 105},
{ date: '2023-01-21', sales: 120},
{ date: '2023-01-22', sales: 175},
{ date: '2023-01-23', sales: 114},
{ date: '2023-01-24', sales: 150},
{ date: '2023-01-25', sales: 168},
{ date: '2023-01-26', sales: 198},
{ date: '2023-01-27', sales: 174},
{ date: '2023-01-28', sales: 116},
{ date: '2023-01-29', sales: 193},
{ date: '2023-01-30', sales: 105},
{ date: '2023-01-31', sales: 191},
{ date: '2023-02-01', sales: 143},
{ date: '2023-02-02', sales: 178},
{ date: '2023-02-03', sales: 166},
{ date: '2023-02-04', sales: 114},
{ date: '2023-02-05', sales: 152},
{ date: '2023-02-06', sales: 144},
{ date: '2023-02-07', sales: 179},
{ date: '2023-02-08', sales: 169},
{ date: '2023-02-09', sales: 146},
{ date: '2023-02-10', sales: 107},
{ date: '2023-02-11', sales: 138},
{ date: '2023-02-12', sales: 148},
{ date: '2023-02-13', sales: 154},
{ date: '2023-02-14', sales: 120},
{ date: '2023-02-15', sales: 128},
{ date: '2023-02-16', sales: 121},
{ date: '2023-02-17', sales: 117},
{ date: '2023-02-18', sales: 149},
{ date: '2023-02-19', sales: 141},
{ date: '2023-02-20', sales: 179},
{ date: '2023-02-21', sales: 119},
{ date: '2023-02-22', sales: 161},
{ date: '2023-02-23', sales: 101},
{ date: '2023-02-24', sales: 198},
{ date: '2023-02-25', sales: 119},
{ date: '2023-02-26', sales: 134},
{ date: '2023-02-27', sales: 181},
{ date: '2023-02-28', sales: 108},
{ date: '2023-03-01', sales: 198},
{ date: '2023-03-02', sales: 112},
{ date: '2023-03-03', sales: 153},
{ date: '2023-03-04', sales: 171},
{ date: '2023-03-05', sales: 134},
{ date: '2023-03-06', sales: 198},
{ date: '2023-03-07', sales: 164},
{ date: '2023-03-08', sales: 157},
{ date: '2023-03-09', sales: 191},
{ date: '2023-03-10', sales: 119},
{ date: '2023-03-11', sales: 142},
{ date: '2023-03-12', sales: 147},
{ date: '2023-03-13', sales: 184},
{ date: '2023-03-14', sales: 151},
{ date: '2023-03-15', sales: 109},
{ date: '2023-03-16', sales: 199},
{ date: '2023-03-17', sales: 112},
{ date: '2023-03-18', sales: 198},
{ date: '2023-03-19', sales: 159},
{ date: '2023-03-20', sales: 188},
{ date: '2023-03-21', sales: 121},
{ date: '2023-03-22', sales: 147},
{ date: '2023-03-23', sales: 102},
{ date: '2023-03-24', sales: 140},
{ date: '2023-03-25', sales: 123},
{ date: '2023-03-26', sales: 173},
{ date: '2023-03-27', sales: 123},
{ date: '2023-03-28', sales: 197},
{ date: '2023-03-29', sales: 147},
{ date: '2023-03-30', sales: 110},
{ date: '2023-03-31', sales: 103},
{ date: '2023-04-01', sales: 142},
{ date: '2023-04-02', sales: 175},
{ date: '2023-04-03', sales: 145},
{ date: '2023-04-04', sales: 151},
{ date: '2023-04-05', sales: 160},
{ date: '2023-04-06', sales: 176},
{ date: '2023-04-07', sales: 112},
{ date: '2023-04-08', sales: 135},
{ date: '2023-04-09', sales: 152},
{ date: '2023-04-10', sales: 108},
{ date: '2023-04-11', sales: 179},
{ date: '2023-04-12', sales: 186},
{ date: '2023-04-13', sales: 129},
{ date: '2023-04-14', sales: 142},
{ date: '2023-04-15', sales: 196},
{ date: '2023-04-16', sales: 171},
{ date: '2023-04-17', sales: 127},
{ date: '2023-04-18', sales: 124},
{ date: '2023-04-19', sales: 117},
{ date: '2023-04-20', sales: 184},
{ date: '2023-04-21', sales: 183},
{ date: '2023-04-22', sales: 113},
{ date: '2023-04-23', sales: 129},
{ date: '2023-04-24', sales: 177},
{ date: '2023-04-25', sales: 154},
{ date: '2023-04-26', sales: 130},
{ date: '2023-04-27', sales: 145},
{ date: '2023-04-28', sales: 124},
{ date: '2023-04-29', sales: 177},
{ date: '2023-04-30', sales: 167},
{ date: '2023-05-01', sales: 181},
{ date: '2023-05-02', sales: 127},
{ date: '2023-05-03', sales: 131},
{ date: '2023-05-04', sales: 147},
{ date: '2023-05-05', sales: 108},
{ date: '2023-05-06', sales: 100},
{ date: '2023-05-07', sales: 143},
{ date: '2023-05-08', sales: 148},
{ date: '2023-05-09', sales: 176},
{ date: '2023-05-10', sales: 134},
{ date: '2023-05-11', sales: 124},
{ date: '2023-05-12', sales: 125},
{ date: '2023-05-13', sales: 184},
{ date: '2023-05-14', sales: 131},
{ date: '2023-05-15', sales: 194},
{ date: '2023-05-16', sales: 186},
{ date: '2023-05-17', sales: 182},
{ date: '2023-05-18', sales: 177},
{ date: '2023-05-19', sales: 185},
{ date: '2023-05-20', sales: 130},
{ date: '2023-05-21', sales: 108},
{ date: '2023-05-22', sales: 194},
{ date: '2023-05-23', sales: 157},
{ date: '2023-05-24', sales: 145},
{ date: '2023-05-25', sales: 112},
{ date: '2023-05-26', sales: 118},
{ date: '2023-05-27', sales: 198},
{ date: '2023-05-28', sales: 166},
{ date: '2023-05-29', sales: 144},
{ date: '2023-05-30', sales: 146},
{ date: '2023-05-31', sales: 129},
{ date: '2023-06-01', sales: 109},
{ date: '2023-06-02', sales: 176},
{ date: '2023-06-03', sales: 155},
{ date: '2023-06-04', sales: 166},
{ date: '2023-06-05', sales: 176},
{ date: '2023-06-06', sales: 199},
{ date: '2023-06-07', sales: 193},
{ date: '2023-06-08', sales: 161},
{ date: '2023-06-09', sales: 150},
{ date: '2023-06-10', sales: 176},
{ date: '2023-06-11', sales: 135},
{ date: '2023-06-12', sales: 162},
{ date: '2023-06-13', sales: 100},
{ date: '2023-06-14', sales: 158},
{ date: '2023-06-15', sales: 154},
{ date: '2023-06-16', sales: 188},
{ date: '2023-06-17', sales: 162},
{ date: '2023-06-18', sales: 126},
{ date: '2023-06-19', sales: 151},
{ date: '2023-06-20', sales: 113},
{ date: '2023-06-21', sales: 138},
{ date: '2023-06-22', sales: 144},
{ date: '2023-06-23', sales: 133},
{ date: '2023-06-24', sales: 134},
{ date: '2023-06-25', sales: 106},
{ date: '2023-06-26', sales: 167},
{ date: '2023-06-27', sales: 169},
{ date: '2023-06-28', sales: 152},
{ date: '2023-06-29', sales: 144},
{ date: '2023-06-30', sales: 138},
{ date: '2023-07-01', sales: 149},
{ date: '2023-07-02', sales: 169},
{ date: '2023-07-03', sales: 138},
{ date: '2023-07-04', sales: 196},
{ date: '2023-07-05', sales: 147},
{ date: '2023-07-06', sales: 197},
{ date: '2023-07-07', sales: 181},
{ date: '2023-07-08', sales: 183},
{ date: '2023-07-09', sales: 141},
{ date: '2023-07-10', sales: 156},
{ date: '2023-07-11', sales: 168},
{ date: '2023-07-12', sales: 123},
{ date: '2023-07-13', sales: 102},
{ date: '2023-07-14', sales: 152},
{ date: '2023-07-15', sales: 156},
{ date: '2023-07-16', sales: 177},
{ date: '2023-07-17', sales: 100},
{ date: '2023-07-18', sales: 118},
{ date: '2023-07-19', sales: 185},
{ date: '2023-07-20', sales: 159},
{ date: '2023-07-21', sales: 149},
{ date: '2023-07-22', sales: 187},
{ date: '2023-07-23', sales: 175},
{ date: '2023-07-24', sales: 120},
{ date: '2023-07-25', sales: 115},
{ date: '2023-07-26', sales: 178},
{ date: '2023-07-27', sales: 143},
{ date: '2023-07-28', sales: 109},
{ date: '2023-07-29', sales: 116},
{ date: '2023-07-30', sales: 116},
{ date: '2023-07-31', sales: 103},
{ date: '2023-08-01', sales: 174},
{ date: '2023-08-02', sales: 180},
{ date: '2023-08-03', sales: 111},
{ date: '2023-08-04', sales: 154},
{ date: '2023-08-05', sales: 162},
{ date: '2023-08-06', sales: 123},
{ date: '2023-08-07', sales: 100},
{ date: '2023-08-08', sales: 144},
{ date: '2023-08-09', sales: 104},
{ date: '2023-08-10', sales: 149},
{ date: '2023-08-11', sales: 123},
{ date: '2023-08-12', sales: 129},
{ date: '2023-08-13', sales: 160},
{ date: '2023-08-14', sales: 131},
{ date: '2023-08-15', sales: 160},
{ date: '2023-08-16', sales: 152},
{ date: '2023-08-17', sales: 132},
{ date: '2023-08-18', sales: 186},
{ date: '2023-08-19', sales: 147},
{ date: '2023-08-20', sales: 158},
{ date: '2023-08-21', sales: 107},
{ date: '2023-08-22', sales: 133},
{ date: '2023-08-23', sales: 200},
{ date: '2023-08-24', sales: 113},
{ date: '2023-08-25', sales: 114},
{ date: '2023-08-26', sales: 176},
{ date: '2023-08-27', sales: 118},
{ date: '2023-08-28', sales: 192},
{ date: '2023-08-29', sales: 151},
{ date: '2023-08-30', sales: 150},
{ date: '2023-08-31', sales: 199},
{ date: '2023-09-01', sales: 116},
{ date: '2023-09-02', sales: 159},
{ date: '2023-09-03', sales: 185},
{ date: '2023-09-04', sales: 172},
{ date: '2023-09-05', sales: 140},
{ date: '2023-09-06', sales: 133},
{ date: '2023-09-07', sales: 193},
{ date: '2023-09-08', sales: 114},
{ date: '2023-09-09', sales: 177},
{ date: '2023-09-10', sales: 128},
{ date: '2023-09-11', sales: 122},
{ date: '2023-09-12', sales: 185},
{ date: '2023-09-13', sales: 116},
{ date: '2023-09-14', sales: 195},
{ date: '2023-09-15', sales: 192},
{ date: '2023-09-16', sales: 175},
{ date: '2023-09-17', sales: 161},
{ date: '2023-09-18', sales: 145},
{ date: '2023-09-19', sales: 103},
{ date: '2023-09-20', sales: 114},
{ date: '2023-09-21', sales: 152},
{ date: '2023-09-22', sales: 197},
{ date: '2023-09-23', sales: 113},
{ date: '2023-09-24', sales: 144},
{ date: '2023-09-25', sales: 162},
{ date: '2023-09-26', sales: 118},
{ date: '2023-09-27', sales: 110},
{ date: '2023-09-28', sales: 133},
{ date: '2023-09-29', sales: 141},
{ date: '2023-09-30', sales: 154},
{ date: '2023-10-01', sales: 195},
{ date: '2023-10-02', sales: 137},
{ date: '2023-10-03', sales: 190},
{ date: '2023-10-04', sales: 164},
{ date: '2023-10-05', sales: 192},
{ date: '2023-10-06', sales: 166},
{ date: '2023-10-07', sales: 118},
{ date: '2023-10-08', sales: 175},
{ date: '2023-10-09', sales: 184},
{ date: '2023-10-10', sales: 122},
{ date: '2023-10-11', sales: 173},
{ date: '2023-10-12', sales: 149},
{ date: '2023-10-13', sales: 159},
{ date: '2023-10-14', sales: 195},
{ date: '2023-10-15', sales: 200},
{ date: '2023-10-16', sales: 196},
{ date: '2023-10-17', sales: 123},
{ date: '2023-10-18', sales: 138},
{ date: '2023-10-19', sales: 111},
{ date: '2023-10-20', sales: 186},
{ date: '2023-10-21', sales: 136},
{ date: '2023-10-22', sales: 196},
{ date: '2023-10-23', sales: 109},
{ date: '2023-10-24', sales: 108},
{ date: '2023-10-25', sales: 197},
{ date: '2023-10-26', sales: 175},
{ date: '2023-10-27', sales: 126},
{ date: '2023-10-28', sales: 168},
{ date: '2023-10-29', sales: 141},
{ date: '2023-10-30', sales: 141},
{ date: '2023-10-31', sales: 103},
{ date: '2023-11-01', sales: 122},
{ date: '2023-11-02', sales: 169},
{ date: '2023-11-03', sales: 140},
{ date: '2023-11-04', sales: 142},
{ date: '2023-11-05', sales: 194},
{ date: '2023-11-06', sales: 143},
{ date: '2023-11-07', sales: 124},
{ date: '2023-11-08', sales: 130},
{ date: '2023-11-09', sales: 170},
{ date: '2023-11-10', sales: 179},
{ date: '2023-11-11', sales: 139},
{ date: '2023-11-12', sales: 187},
{ date: '2023-11-13', sales: 198},
{ date: '2023-11-14', sales: 107},
{ date: '2023-11-15', sales: 172},
{ date: '2023-11-16', sales: 121},
{ date: '2023-11-17', sales: 187},
{ date: '2023-11-18', sales: 173},
{ date: '2023-11-19', sales: 177},
{ date: '2023-11-20', sales: 138},
{ date: '2023-11-21', sales: 141},
{ date: '2023-11-22', sales: 172},
{ date: '2023-11-23', sales: 115},
{ date: '2023-11-24', sales: 151},
{ date: '2023-11-25', sales: 140},
{ date: '2023-11-26', sales: 184},
{ date: '2023-11-27', sales: 145},
{ date: '2023-11-28', sales: 198},
{ date: '2023-11-29', sales: 169},
{ date: '2023-11-30', sales: 138},
{ date: '2023-12-01', sales: 194},
{ date: '2023-12-02', sales: 170},
{ date: '2023-12-03', sales: 144},
{ date: '2023-12-04', sales: 177},
{ date: '2023-12-05', sales: 181},
{ date: '2023-12-06', sales: 117},
{ date: '2023-12-07', sales: 115},
{ date: '2023-12-08', sales: 157},
{ date: '2023-12-09', sales: 188},
{ date: '2023-12-10', sales: 183},
{ date: '2023-12-11', sales: 116},
{ date: '2023-12-12', sales: 114},
{ date: '2023-12-13', sales: 167},
{ date: '2023-12-14', sales: 175},
{ date: '2023-12-15', sales: 168},
{ date: '2023-12-16', sales: 168},
{ date: '2023-12-17', sales: 177},
{ date: '2023-12-18', sales: 101},
{ date: '2023-12-19', sales: 162},
{ date: '2023-12-20', sales: 123},
{ date: '2023-12-21', sales: 129},
{ date: '2023-12-22', sales: 100},
{ date: '2023-12-23', sales: 164},
{ date: '2023-12-24', sales: 132},
{ date: '2023-12-25', sales: 159},
{ date: '2023-12-26', sales: 189},
{ date: '2023-12-27', sales: 136},
{ date: '2023-12-28', sales: 196},
{ date: '2023-12-29', sales: 131},
{ date: '2023-12-30', sales: 112},
{ date: '2023-12-31', sales: 141},
{ date: '2024-01-01', sales: 108},
{ date: '2024-01-02', sales: 199},
{ date: '2024-01-03', sales: 140},
{ date: '2024-01-04', sales: 153},
{ date: '2024-01-05', sales: 153},
{ date: '2024-01-06', sales: 163},
{ date: '2024-01-07', sales: 133},
{ date: '2024-01-08', sales: 134},
{ date: '2024-01-09', sales: 176},
{ date: '2024-01-10', sales: 192},
{ date: '2024-01-11', sales: 198},
{ date: '2024-01-12', sales: 194},
{ date: '2024-01-13', sales: 186},
{ date: '2024-01-14', sales: 183},
{ date: '2024-01-15', sales: 106},
{ date: '2024-01-16', sales: 164},
{ date: '2024-01-17', sales: 196},
{ date: '2024-01-18', sales: 119},
{ date: '2024-01-19', sales: 125},
{ date: '2024-01-20', sales: 142},
{ date: '2024-01-21', sales: 165},
{ date: '2024-01-22', sales: 191},
{ date: '2024-01-23', sales: 166},
{ date: '2024-01-24', sales: 131},
{ date: '2024-01-25', sales: 102},
{ date: '2024-01-26', sales: 137},
{ date: '2024-01-27', sales: 163},
{ date: '2024-01-28', sales: 150},
{ date: '2024-01-29', sales: 101},
{ date: '2024-01-30', sales: 110},
{ date: '2024-01-31', sales: 164},
{ date: '2024-02-01', sales: 200},
{ date: '2024-02-02', sales: 114},
{ date: '2024-02-03', sales: 118},
{ date: '2024-02-04', sales: 182},
{ date: '2024-02-05', sales: 144},
{ date: '2024-02-06', sales: 181},
{ date: '2024-02-07', sales: 126},
{ date: '2024-02-08', sales: 122},
{ date: '2024-02-09', sales: 189},
{ date: '2024-02-10', sales: 103},
{ date: '2024-02-11', sales: 159},
{ date: '2024-02-12', sales: 129},
{ date: '2024-02-13', sales: 173},
{ date: '2024-02-14', sales: 151},
{ date: '2024-02-15', sales: 129},
{ date: '2024-02-16', sales: 124},
{ date: '2024-02-17', sales: 182},
{ date: '2024-02-18', sales: 113},
{ date: '2024-02-19', sales: 123},
{ date: '2024-02-20', sales: 112},
{ date: '2024-02-21', sales: 146},
{ date: '2024-02-22', sales: 144},
{ date: '2024-02-23', sales: 139},
{ date: '2024-02-24', sales: 124},
{ date: '2024-02-25', sales: 126},
{ date: '2024-02-26', sales: 185},
{ date: '2024-02-27', sales: 162},
{ date: '2024-02-28', sales: 132},
{ date: '2024-02-29', sales: 192},
{ date: '2024-03-01', sales: 157},
{ date: '2024-03-02', sales: 114},
{ date: '2024-03-03', sales: 190},
{ date: '2024-03-04', sales: 117},
{ date: '2024-03-05', sales: 129},
{ date: '2024-03-06', sales: 194},
{ date: '2024-03-07', sales: 158},
{ date: '2024-03-08', sales: 172},
{ date: '2024-03-09', sales: 200},
{ date: '2024-03-10', sales: 115},
{ date: '2024-03-11', sales: 196},
{ date: '2024-03-12', sales: 168},
{ date: '2024-03-13', sales: 173},
{ date: '2024-03-14', sales: 112},
{ date: '2024-03-15', sales: 158},
{ date: '2024-03-16', sales: 132},
{ date: '2024-03-17', sales: 147},
{ date: '2024-03-18', sales: 103},
{ date: '2024-03-19', sales: 112},
{ date: '2024-03-20', sales: 100},
{ date: '2024-03-21', sales: 196},
{ date: '2024-03-22', sales: 154},
{ date: '2024-03-23', sales: 190},
{ date: '2024-03-24', sales: 188},
{ date: '2024-03-25', sales: 176},
{ date: '2024-03-26', sales: 136},
{ date: '2024-03-27', sales: 151},
{ date: '2024-03-28', sales: 117},
{ date: '2024-03-29', sales: 115},
{ date: '2024-03-30', sales: 160},
{ date: '2024-03-31', sales: 145},
{ date: '2024-04-01', sales: 115},
{ date: '2024-04-02', sales: 188},
{ date: '2024-04-03', sales: 146},
{ date: '2024-04-04', sales: 114},
{ date: '2024-04-05', sales: 140},
{ date: '2024-04-06', sales: 100},
{ date: '2024-04-07', sales: 137},
{ date: '2024-04-08', sales: 183},
{ date: '2024-04-09', sales: 184},
{ date: '2024-04-10', sales: 117},
{ date: '2024-04-11', sales: 179},
{ date: '2024-04-12', sales: 131},
{ date: '2024-04-13', sales: 107},
{ date: '2024-04-14', sales: 167},
{ date: '2024-04-15', sales: 200},
{ date: '2024-04-16', sales: 146},
{ date: '2024-04-17', sales: 126},
{ date: '2024-04-18', sales: 128},
{ date: '2024-04-19', sales: 174},
{ date: '2024-04-20', sales: 133},
{ date: '2024-04-21', sales: 180},
{ date: '2024-04-22', sales: 157},
{ date: '2024-04-23', sales: 135},
{ date: '2024-04-24', sales: 122},
{ date: '2024-04-25', sales: 173},
{ date: '2024-04-26', sales: 146},
{ date: '2024-04-27', sales: 115},
{ date: '2024-04-28', sales: 131},
{ date: '2024-04-29', sales: 154},
{ date: '2024-04-30', sales: 122},
{ date: '2024-05-01', sales: 195},
{ date: '2024-05-02', sales: 191},
{ date: '2024-05-03', sales: 114},
{ date: '2024-05-04', sales: 141},
{ date: '2024-05-05', sales: 147},
{ date: '2024-05-06', sales: 189},
{ date: '2024-05-07', sales: 187},
{ date: '2024-05-08', sales: 195},
{ date: '2024-05-09', sales: 147},
{ date: '2024-05-10', sales: 182},
{ date: '2024-05-11', sales: 190},
{ date: '2024-05-12', sales: 175},
{ date: '2024-05-13', sales: 158},
{ date: '2024-05-14', sales: 165},
{ date: '2024-05-15', sales: 174},
{ date: '2024-05-16', sales: 142},
{ date: '2024-05-17', sales: 141},
{ date: '2024-05-18', sales: 184},
{ date: '2024-05-19', sales: 124},
{ date: '2024-05-20', sales: 136},
{ date: '2024-05-21', sales: 176},
{ date: '2024-05-22', sales: 153},
{ date: '2024-05-23', sales: 152},
{ date: '2024-05-24', sales: 111},
{ date: '2024-05-25', sales: 171},
{ date: '2024-05-26', sales: 104},
{ date: '2024-05-27', sales: 143},
{ date: '2024-05-28', sales: 148},
{ date: '2024-05-29', sales: 145},
{ date: '2024-05-30', sales: 177},
{ date: '2024-05-31', sales: 141},
{ date: '2024-06-01', sales: 134},
{ date: '2024-06-02', sales: 186},
{ date: '2024-06-03', sales: 157},
{ date: '2024-06-04', sales: 158},
{ date: '2024-06-05', sales: 114},
{ date: '2024-06-06', sales: 180},
{ date: '2024-06-07', sales: 134},
{ date: '2024-06-08', sales: 114},
{ date: '2024-06-09', sales: 179},
{ date: '2024-06-10', sales: 139},
{ date: '2024-06-11', sales: 119},
{ date: '2024-06-12', sales: 163},
{ date: '2024-06-13', sales: 188},
{ date: '2024-06-14', sales: 170},
{ date: '2024-06-15', sales: 101},
{ date: '2024-06-16', sales: 184},
{ date: '2024-06-17', sales: 130},
{ date: '2024-06-18', sales: 160},
{ date: '2024-06-19', sales: 168},
{ date: '2024-06-20', sales: 158},
{ date: '2024-06-21', sales: 172},
{ date: '2024-06-22', sales: 142},
{ date: '2024-06-23', sales: 144},
{ date: '2024-06-24', sales: 149},
{ date: '2024-06-25', sales: 145},
{ date: '2024-06-26', sales: 127},
{ date: '2024-06-27', sales: 111},
{ date: '2024-06-28', sales: 132},
{ date: '2024-06-29', sales: 156},
{ date: '2024-06-30', sales: 188},
{ date: '2024-07-01', sales: 144},
{ date: '2024-07-02', sales: 199},
{ date: '2024-07-03', sales: 132},
{ date: '2024-07-04', sales: 139},
{ date: '2024-07-05', sales: 149},
{ date: '2024-07-06', sales: 153},
{ date: '2024-07-07', sales: 198},
{ date: '2024-07-08', sales: 160},
{ date: '2024-07-09', sales: 196},
{ date: '2024-07-10', sales: 170},
{ date: '2024-07-11', sales: 168},
{ date: '2024-07-12', sales: 120},
{ date: '2024-07-13', sales: 139},
{ date: '2024-07-14', sales: 164},
{ date: '2024-07-15', sales: 113},
{ date: '2024-07-16', sales: 169},
{ date: '2024-07-17', sales: 142},
{ date: '2024-07-18', sales: 163},
{ date: '2024-07-19', sales: 116},
{ date: '2024-07-20', sales: 176},
{ date: '2024-07-21', sales: 107},
{ date: '2024-07-22', sales: 197},
{ date: '2024-07-23', sales: 197},
{ date: '2024-07-24', sales: 101},
{ date: '2024-07-25', sales: 139},
{ date: '2024-07-26', sales: 182},
{ date: '2024-07-27', sales: 177},
{ date: '2024-07-28', sales: 191},
{ date: '2024-07-29', sales: 171},
{ date: '2024-07-30', sales: 151},
{ date: '2024-07-31', sales: 178},
{ date: '2024-08-01', sales: 167},
{ date: '2024-08-02', sales: 145},
{ date: '2024-08-03', sales: 191},
{ date: '2024-08-04', sales: 160},
{ date: '2024-08-05', sales: 114},
{ date: '2024-08-06', sales: 159},
{ date: '2024-08-07', sales: 157},
{ date: '2024-08-08', sales: 200},
{ date: '2024-08-09', sales: 194},
{ date: '2024-08-10', sales: 177},
{ date: '2024-08-11', sales: 108},
{ date: '2024-08-12', sales: 171},
{ date: '2024-08-13', sales: 127},
{ date: '2024-08-14', sales: 119},
{ date: '2024-08-15', sales: 183},
{ date: '2024-08-16', sales: 167},
{ date: '2024-08-17', sales: 150},
{ date: '2024-08-18', sales: 126},
{ date: '2024-08-19', sales: 160},
{ date: '2024-08-20', sales: 152},
{ date: '2024-08-21', sales: 158},
{ date: '2024-08-22', sales: 104},
{ date: '2024-08-23', sales: 150},
{ date: '2024-08-24', sales: 103},
{ date: '2024-08-25', sales: 174},
{ date: '2024-08-26', sales: 166},
{ date: '2024-08-27', sales: 173},
{ date: '2024-08-28', sales: 138},
{ date: '2024-08-29', sales: 152},
{ date: '2024-08-30', sales: 126},
{ date: '2024-08-31', sales: 172},
{ date: '2024-09-01', sales: 102},
{ date: '2024-09-02', sales: 103},
{ date: '2024-09-03', sales: 184},
{ date: '2024-09-04', sales: 195},
{ date: '2024-09-05', sales: 164},
{ date: '2024-09-06', sales: 181},
{ date: '2024-09-07', sales: 143},
{ date: '2024-09-08', sales: 160},
{ date: '2024-09-09', sales: 168},
{ date: '2024-09-10', sales: 152},
{ date: '2024-09-11', sales: 155},
{ date: '2024-09-12', sales: 200},
{ date: '2024-09-13', sales: 115},
{ date: '2024-09-14', sales: 185},
{ date: '2024-09-15', sales: 145},
{ date: '2024-09-16', sales: 115},
{ date: '2024-09-17', sales: 175},
{ date: '2024-09-18', sales: 127},
{ date: '2024-09-19', sales: 184},
{ date: '2024-09-20', sales: 108},
{ date: '2024-09-21', sales: 186},
{ date: '2024-09-22', sales: 119},
{ date: '2024-09-23', sales: 115},
{ date: '2024-09-24', sales: 168},
{ date: '2024-09-25', sales: 124},
{ date: '2024-09-26', sales: 147},
{ date: '2024-09-27', sales: 171},
{ date: '2024-09-28', sales: 146},
{ date: '2024-09-29', sales: 188},
{ date: '2024-09-30', sales: 120},
{ date: '2024-10-01', sales: 150},
{ date: '2024-10-02', sales: 196},
{ date: '2024-10-03', sales: 135},
{ date: '2024-10-04', sales: 192},
{ date: '2024-10-05', sales: 124},
{ date: '2024-10-06', sales: 176},
{ date: '2024-10-07', sales: 109},
{ date: '2024-10-08', sales: 175},
{ date: '2024-10-09', sales: 180},
{ date: '2024-10-10', sales: 156},
{ date: '2024-10-11', sales: 198},
{ date: '2024-10-12', sales: 151},
{ date: '2024-10-13', sales: 154},
{ date: '2024-10-14', sales: 106},
{ date: '2024-10-15', sales: 177},
{ date: '2024-10-16', sales: 100},
{ date: '2024-10-17', sales: 105},
{ date: '2024-10-18', sales: 119},
{ date: '2024-10-19', sales: 178},
{ date: '2024-10-20', sales: 138},
{ date: '2024-10-21', sales: 180},
{ date: '2024-10-22', sales: 122},
{ date: '2024-10-23', sales: 182},
{ date: '2024-10-24', sales: 153},
{ date: '2024-10-25', sales: 172},
{ date: '2024-10-26', sales: 188},
{ date: '2024-10-27', sales: 129},
{ date: '2024-10-28', sales: 111},
{ date: '2024-10-29', sales: 155},
{ date: '2024-10-30', sales: 199},
{ date: '2024-10-31', sales: 123},
{ date: '2024-11-01', sales: 123},
{ date: '2024-11-02', sales: 182},
{ date: '2024-11-03', sales: 181},
{ date: '2024-11-04', sales: 110},
{ date: '2024-11-05', sales: 179},
{ date: '2024-11-06', sales: 196},
{ date: '2024-11-07', sales: 172},
{ date: '2024-11-08', sales: 110},
{ date: '2024-11-09', sales: 114},
{ date: '2024-11-10', sales: 143},
{ date: '2024-11-11', sales: 194},
{ date: '2024-11-12', sales: 197},
{ date: '2024-11-13', sales: 105},
{ date: '2024-11-14', sales: 167},
{ date: '2024-11-15', sales: 105},
{ date: '2024-11-16', sales: 140},
{ date: '2024-11-17', sales: 196},
{ date: '2024-11-18', sales: 183},
{ date: '2024-11-19', sales: 165},
{ date: '2024-11-20', sales: 184},
{ date: '2024-11-21', sales: 107},
{ date: '2024-11-22', sales: 146},
{ date: '2024-11-23', sales: 157},
{ date: '2024-11-24', sales: 112},
{ date: '2024-11-25', sales: 149},
{ date: '2024-11-26', sales: 173},
{ date: '2024-11-27', sales: 180},
{ date: '2024-11-28', sales: 169},
{ date: '2024-11-29', sales: 112},
{ date: '2024-11-30', sales: 157},
{ date: '2024-12-01', sales: 121},
{ date: '2024-12-02', sales: 159},
{ date: '2024-12-03', sales: 164},
{ date: '2024-12-04', sales: 171},
{ date: '2024-12-05', sales: 199},
{ date: '2024-12-06', sales: 135},
{ date: '2024-12-07', sales: 137},
{ date: '2024-12-08', sales: 125},
{ date: '2024-12-09', sales: 137},
{ date: '2024-12-10', sales: 174},
{ date: '2024-12-11', sales: 138},
{ date: '2024-12-12', sales: 136},
{ date: '2024-12-13', sales: 130},
{ date: '2024-12-14', sales: 152},
{ date: '2024-12-15', sales: 185},
{ date: '2024-12-16', sales: 148},
{ date: '2024-12-17', sales: 148},
{ date: '2024-12-18', sales: 146},
{ date: '2024-12-19', sales: 117},
{ date: '2024-12-20', sales: 149},
{ date: '2024-12-21', sales: 200},
{ date: '2024-12-22', sales: 131},
{ date: '2024-12-23', sales: 177},
{ date: '2024-12-24', sales: 124},
{ date: '2024-12-25', sales: 134},
{ date: '2024-12-26', sales: 128},
{ date: '2024-12-27', sales: 172},
{ date: '2024-12-28', sales: 146},
{ date: '2024-12-29', sales: 167},

    ];

    // Chart instance variable
    let chart;

    /**
     * Gets current theme colors from CSS variables
     * @return {object} Object with colors for the chart
     */
    function getThemeColors() {
        // Use document.body to get computed styles, as the theme class is applied there
        const style = getComputedStyle(document.body);
        const colors = {
            actual: style.getPropertyValue('--chart-actual').trim(),
            past: style.getPropertyValue('--chart-past').trim(),
            pastFillStart: style.getPropertyValue('--chart-past-fill-start').trim(),
            pastFillEnd: style.getPropertyValue('--chart-past-fill-end').trim(),
            average: style.getPropertyValue('--chart-average').trim(),
            anomalies: style.getPropertyValue('--chart-anomalies').trim(),
            legendText: style.getPropertyValue('--chart-legend-text').trim(),
            ticksText: style.getPropertyValue('--chart-ticks-text').trim(),
            titleText: style.getPropertyValue('--chart-title-text').trim(),
            gridColor: style.getPropertyValue('--chart-grid-color').trim() // Get the new grid color
        };
        console.log('Current theme colors:', colors); // Log current colors
        return colors;
    }


    /**
     * Main function to render the chart with current filters and theme
     */
    function renderChart() {
      // Get current filter values
      const grouping = document.getElementById('grouping').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      // Filter data by date range
      const filteredData = salesData.filter(item => {
          const itemDate = new Date(item.date);
          itemDate.setHours(0,0,0,0); // Consider date part only
          // Ensure start and end dates are valid before comparing
          const start = new Date(startDate);
          const end = new Date(endDate);
          return !isNaN(start) && !isNaN(end) && itemDate >= start && itemDate <= end;
      });


      // Group data by selected period
      const groupedData = groupData(filteredData, grouping);
      const labels = groupedData.map(item => item.sortDate);
      const currentValues = groupedData.map(item => item.value);

      // Get data for the past period (1 year ago)
      const pastStartDate = subtractOneYear(startDate);
      const pastEndDate = subtractOneYear(endDate);
      const filteredPastData = salesData.filter(item => {
          const itemDate = new Date(item.date);
          itemDate.setHours(0,0,0,0);
          // Ensure past start and end dates are valid before comparing
          const pastStart = new Date(pastStartDate);
          const pastEnd = new Date(pastEndDate);
          return !isNaN(pastStart) && !isNaN(pastEnd) && itemDate >= pastStart && itemDate <= pastEnd;
      });
      const pastGroupedData = groupData(filteredPastData, grouping);

      // Create a map of past period labels to values
      const pastDataMap = {};
      pastGroupedData.forEach(item => {
        pastDataMap[item.label] = item.value;
      });

      // Get past values aligned with current period labels
      const pastValues = groupedData.map(item => {
        const pastLabel = getPastLabel(item.label, grouping);
        return pastDataMap[pastLabel] !== undefined ? pastDataMap[pastLabel] : null; // Use null for missing data
      });

      // Get current state of toggles
      const pastPeriodVisible = document.getElementById('togglePastPeriod').checked;
      const showGrid = document.getElementById('toggleGrid').checked;
      const showDataPoints = document.getElementById('toggleDataValues').checked;
      const showAverage = document.getElementById('toggleAverage').checked;
      const showAnomalies = document.getElementById('toggleAnomalies').checked;

      // Calculate moving average (7 days for daily, 3 periods for others)
      const period = (grouping === 'daily') ? 7 : 3;
      const movingAverage = currentValues.map((value, index, arr) => {
        const startIdx = Math.max(0, index - period + 1);
        const subset = arr.slice(startIdx, index + 1);
        // Ensure all values in the subset are numbers
        const numericSubset = subset.filter(v => typeof v === 'number');
        if (numericSubset.length === 0) return null; // Return null if no numeric data
        const sum = numericSubset.reduce((s, v) => s + v, 0);
        return sum / numericSubset.length;
      });


      // Identify anomalies (>20% deviation from moving average)
      const anomalies = currentValues.map((value, index) => {
        const avg = movingAverage[index];
        // Check if both value and average are numbers
        if (typeof value !== 'number' || typeof avg !== 'number' || avg === 0) {
            return null;
        }
        // Use Math.abs for deviation
        return (Math.abs(value - avg) > 0.2 * Math.abs(avg)) ? value : null;
      });


      // Get chart context
      const ctx = document.getElementById('salesChart').getContext('2d');

      // Get current theme colors
      const themeColors = getThemeColors();

      // Create gradient for past period fill based on theme
      // Ensure canvas height is available before creating gradient
      const canvasHeight = ctx.canvas.height > 0 ? ctx.canvas.height : 400; // Use a default if 0
      const gradient = ctx.createLinearGradient(0, 0, 0, canvasHeight);
      gradient.addColorStop(0, themeColors.pastFillStart);
      gradient.addColorStop(0.8, themeColors.pastFillEnd); // Use container background color for smooth transition

      // Calculate the maximum value among the displayed datasets (current and past)
      const allDisplayedValues = [];
      if (currentValues.length > 0) {
          allDisplayedValues.push(...currentValues.filter(v => typeof v === 'number'));
      }
       if (pastPeriodVisible && pastValues.length > 0) {
           allDisplayedValues.push(...pastValues.filter(v => typeof v === 'number'));
       }


      let maxYValue = 0;
      if (allDisplayedValues.length > 0) {
          const maxDataValue = Math.max(...allDisplayedValues);
          // Calculate Y-axis max with 20% buffer
          maxYValue = maxDataValue * 1.2;
      } else {
           // If no data, set a default max value or keep it at 0
           maxYValue = 100; // Example default
      }


      // Destroy previous chart instance if it exists
      if (chart) {
        chart.destroy();
      }

      // Create new chart
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Current Sales',
              data: currentValues,
              borderColor: themeColors.actual,
              backgroundColor: themeColors.actual, // For points
              borderWidth: 3,
              fill: false,
              tension: 0.4,
              pointRadius: showDataPoints ? 3 : 0,
              pointHoverRadius: showDataPoints ? 5 : 0
            },
            {
              label: 'Past Period (1 Year Ago)',
              data: pastValues,
              borderColor: themeColors.past,
              backgroundColor: gradient, // Use gradient fill
              borderWidth: 1, // Thinner line for past period
              fill: true, // Enable fill
              tension: 0.4,
              hidden: !pastPeriodVisible,
              pointRadius: showDataPoints ? 3 : 0,
              pointHoverRadius: showDataPoints ? 5 : 0,
              spanGaps: true // Connect points across null values
            },
            {
              label: 'Average Sales',
              data: movingAverage,
              borderColor: themeColors.average,
              backgroundColor: themeColors.average,
              borderWidth: 1.5, // Average line thickness
              borderDash: [5, 5], // Dashed line
              fill: false,
              tension: 0.4,
              hidden: !showAverage,
              pointRadius: showDataPoints ? 3 : 0,
              pointHoverRadius: showDataPoints ? 5 : 0,
              spanGaps: true
            },
            {
              label: 'Anomalies',
              data: anomalies,
              borderColor: themeColors.anomalies,
              backgroundColor: themeColors.anomalies, // Point color
              fill: false,
              tension: 0.4,
              hidden: !showAnomalies,
              pointRadius: 5, // Larger radius for anomalies
              pointHoverRadius: 7,
              showLine: false // Don't connect anomaly points with a line
            }
          ]
        },
        options: {
          responsive: true, // Make chart responsive
          maintainAspectRatio: false, // Allows setting custom height
          interaction: {
              mode: 'index', // Show tooltips for all points on the same X-axis index
              intersect: false // Tooltip appears when hovering over the X-axis area
          },
          plugins: {
            legend: {
              display: true,
              labels: {
                color: themeColors.legendText, // Legend text color from theme
                boxWidth: 10,
                boxHeight: 10,
                // Filter to show only visible datasets
                filter: function(legendItem, chartData) {
                  const ds = chartData.datasets[legendItem.datasetIndex];
                  return !ds.hidden;
                }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                // Format tooltip title
                title: (tooltipItems) => {
                  // Use the first item to get the date
                  if (!tooltipItems.length) return '';
                  const date = new Date(tooltipItems[0].parsed.x);
                  return formatXAxisLabel(date, grouping);
                },
                 // Format tooltip label value
                 label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed.y !== null && typeof context.parsed.y === 'number') {
                        // Use formatNumber for localized formatting
                        label += formatNumber(context.parsed.y);
                    } else {
                         label += '-'; // Show dash for null/undefined
                    }
                    return label;
                }
              }
            },
            datalabels: { // DataLabels plugin settings
              display: showDataPoints, // Toggle display
              align: 'top', // Align above the point
              offset: 5, // Offset from the point
              formatter: function(value, context) {
                // Display only for 'Anomalies' dataset or if showDataPoints is enabled for others
                if (context.dataset.label === 'Anomalies' || showDataPoints) {
                    return (typeof value === 'number') ? Math.round(value) : ''; // Round the number
                }
                return ''; // Don't display for other datasets if showDataPoints is off
              },
              color: function(context) {
                  // Use the dataset's border color for the label
                  return context.dataset.borderColor;
              },
              font: {
                  weight: 'bold'
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                // Define time unit for X-axis
                unit: (grouping === 'daily')
                  ? 'day'
                  : (grouping === 'weekly' || grouping === 'monthly' || grouping === 'quarterly')
                    ? 'month'
                    : 'year',
                // Display formats for different time units
                displayFormats: {
                    day: 'MMM dd', // 'Jan 01'
                    month: 'MMM-yy', // 'Jan-23'
                    year: 'yyyy' // '2023'
                }
              },
              ticks: {
                color: themeColors.ticksText, // X-axis ticks color from theme
                // Format X-axis tick labels
                callback: function(value, index, ticks) {
                  const date = new Date(value);
                  // Skip some labels for readability if there are many
                   if (ticks.length > 20 && index % Math.ceil(ticks.length / 15) !== 0) {
                       return null; // Skip label
                   }
                  return formatXAxisLabel(date, grouping);
                },
                maxRotation: 45, // Max rotation angle for labels
                minRotation: 0
              },
              grid: {
                  display: showGrid, // Show/hide X-axis grid
                  color: themeColors.gridColor // Use the new grid color variable
              },
              title: {
                  display: true,
                  text: 'Period', // X-axis title
                  color: themeColors.titleText // X-axis title color from theme
              }
            },
            y: {
              min: 0, // Minimum Y-axis value
              max: maxYValue, // Set the calculated max value
              ticks: {
                color: themeColors.ticksText, // Y-axis ticks color from theme
                // Format Y-axis tick labels
                callback: function(value) {
                  // Use formatNumber for localized formatting
                  return formatNumber(value);
                }
              },
              grid: {
                  display: showGrid, // Show/hide Y-axis grid
                  color: themeColors.gridColor // Use the new grid color variable
              },
              title: {
                  display: true,
                  text: 'Sales', // Y-axis title
                  color: themeColors.titleText // Y-axis title color from theme
              }
            }
          }
        }
      });

      // Update summary cards with the full dataset
      renderSummaries(salesData);
    }

    // --- Theme Toggle Logic ---
    const themeToggleButton = document.getElementById('theme-toggle');
    const body = document.body;

    // Check for saved theme in localStorage
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme === 'light') {
        body.classList.add('light-theme');
        themeToggleButton.textContent = 'Dark Mode';
    } else {
        themeToggleButton.textContent = 'Light Mode'; // Default is dark
    }

    themeToggleButton.addEventListener('click', () => {
        console.log('Theme toggled, rendering chart...'); // Log theme toggle
        body.classList.toggle('light-theme');

        // Update button text and save theme preference
        if (body.classList.contains('light-theme')) {
            themeToggleButton.textContent = 'Dark Mode';
            localStorage.setItem('theme', 'light');
        } else {
            themeToggleButton.textContent = 'Light Mode';
            localStorage.setItem('theme', 'dark');
        }

        // Re-render the chart with new theme colors
        renderChart();
    });


    // Add event listeners for all filter controls
    document.getElementById('startDate').addEventListener('change', renderChart);
    document.getElementById('endDate').addEventListener('change', renderChart);
    document.getElementById('grouping').addEventListener('change', renderChart);
    document.getElementById('togglePastPeriod').addEventListener('change', renderChart);
    document.getElementById('toggleGrid').addEventListener('change', renderChart);
    document.getElementById('toggleDataValues').addEventListener('change', renderChart);
    document.getElementById('toggleAnomalies').addEventListener('change', renderChart);
    document.getElementById('toggleAverage').addEventListener('change', renderChart);

    // Initialize the page and render chart on window load
    window.onload = function() {
        initializeDateFilters(); // Set date ranges
        renderChart(); // Initial render of chart (without past period)

        // Set a timeout to check the checkbox and re-render after 300ms
        setTimeout(() => {
            const togglePastPeriodCheckbox = document.getElementById('togglePastPeriod');
            if (togglePastPeriodCheckbox) {
                togglePastPeriodCheckbox.checked = true;
                renderChart(); // Re-render the chart with past period visible
            }
        }, 300); // 300 milliseconds delay
    };


    // Add a resize event listener to re-render the chart when the window is resized
    window.addEventListener('resize', renderChart);

  </script>
</body>
</html>
